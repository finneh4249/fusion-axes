<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fusion Party Value Alignment Quiz</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="shortcut icon" type="image/png" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="assets/css/main.css" rel="stylesheet" type="text/css">
    <style>
        /* Quiz Mode Toggle */
        .quiz-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-3);
            box-shadow: var(--shadow-lg);
        }
        
        .toggle-button {
            background: var(--color-gray-100);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-base);
            padding: var(--spacing-2) var(--spacing-4);
            margin: 0 var(--spacing-1);
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            transition: var(--transition-fast);
        }
        
        .toggle-button:hover {
            background: var(--color-gray-200);
        }
        
        .toggle-button.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        
        /* Quiz type visibility */
        .quiz-mode {
            display: none;
        }
        
        .quiz-mode.active {
            display: block;
        }
    </style>
</head>
<body class="quiz-page">
    <!-- Questions data -->
    <script type="application/javascript" src="questions.js"></script>
    
    <!-- Quiz Mode Toggle -->
    <div class="quiz-mode-toggle">
        <button class="toggle-button active" onclick="switchQuizMode('quick')">Quick Quiz</button>
        <button class="toggle-button" onclick="switchQuizMode('full')">Full Assessment</button>
    </div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="icon.svg" alt="Fusion Party" class="nav-logo">
                <span class="nav-title">Fusion Party</span>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="instructions.html" class="nav-link">Instructions</a>
                <a href="unified-quiz.html" class="nav-link active">Quiz</a>
            </div>
        </div>
    </nav>

    <!-- Quick Quiz Mode -->
    <main class="quiz-container quiz-mode active" id="quick-quiz">
        <div class="quiz-header">
            <h1 class="quiz-title">Quick Value Assessment</h1>
            <p class="quiz-subtitle">A brief evaluation of your political values alignment</p>
            
            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="quick-progress-fill"></div>
                </div>
                <div class="progress-text" id="quick-question-number">Loading...</div>
            </div>
        </div>

        <!-- Question Card -->
        <div class="question-card">
            <div class="question-content">
                <p class="question-text" id="quick-question-text">Loading your first question...</p>
            </div>

            <!-- Answer Options -->
            <div class="answer-options">
                <button class="answer-btn strongly-agree" onclick="answerQuestion(2, 'quick')" data-value="2">
                    <span class="answer-icon">üëç</span>
                    <span class="answer-text">Strongly Agree</span>
                </button>
                <button class="answer-btn agree" onclick="answerQuestion(1, 'quick')" data-value="1">
                    <span class="answer-icon">‚úì</span>
                    <span class="answer-text">Agree</span>
                </button>
                <button class="answer-btn neutral" onclick="answerQuestion(0, 'quick')" data-value="0">
                    <span class="answer-icon">‚óã</span>
                    <span class="answer-text">Neutral/Unsure</span>
                </button>
                <button class="answer-btn disagree" onclick="answerQuestion(-1, 'quick')" data-value="-1">
                    <span class="answer-icon">‚úó</span>
                    <span class="answer-text">Disagree</span>
                </button>
                <button class="answer-btn strongly-disagree" onclick="answerQuestion(-2, 'quick')" data-value="-2">
                    <span class="answer-icon">üëé</span>
                    <span class="answer-text">Strongly Disagree</span>
                </button>
            </div>

            <!-- Navigation -->
            <div class="quiz-navigation">
                <button class="nav-btn prev-btn" onclick="prevQuestion('quick')" id="quick-back-button">
                    ‚Üê Previous Question
                </button>
                <button class="nav-btn prev-btn disabled" id="quick-back-button-off" disabled>
                    ‚Üê Previous Question
                </button>
                <div class="keyboard-hint">
                    Use keys 1-5 or Space to answer
                </div>
            </div>
        </div>
    </main>

    <!-- Full Quiz Mode -->
    <main class="quiz-container quiz-mode" id="full-quiz">
        <div class="quiz-header">
            <h1 class="quiz-title">Complete Value Assessment</h1>
            <p class="quiz-subtitle">Comprehensive evaluation of your political values alignment</p>
            
            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="full-progress-fill"></div>
                </div>
                <div class="progress-text" id="full-question-number">Loading...</div>
            </div>
        </div>

        <!-- Question Card -->
        <div class="question-card">
            <div class="question-content">
                <p class="question-text" id="full-question-text">Loading your first question...</p>
            </div>

            <!-- Answer Options -->
            <div class="answer-options">
                <button class="answer-btn strongly-agree" onclick="answerQuestion(2, 'full')" data-value="2">
                    <span class="answer-icon">üëç</span>
                    <span class="answer-text">Strongly Agree</span>
                </button>
                <button class="answer-btn agree" onclick="answerQuestion(1, 'full')" data-value="1">
                    <span class="answer-icon">‚úì</span>
                    <span class="answer-text">Agree</span>
                </button>
                <button class="answer-btn neutral" onclick="answerQuestion(0, 'full')" data-value="0">
                    <span class="answer-icon">‚óã</span>
                    <span class="answer-text">Neutral/Unsure</span>
                </button>
                <button class="answer-btn disagree" onclick="answerQuestion(-1, 'full')" data-value="-1">
                    <span class="answer-icon">‚úó</span>
                    <span class="answer-text">Disagree</span>
                </button>
                <button class="answer-btn strongly-disagree" onclick="answerQuestion(-2, 'full')" data-value="-2">
                    <span class="answer-icon">üëé</span>
                    <span class="answer-text">Strongly Disagree</span>
                </button>
            </div>

            <!-- Navigation -->
            <div class="quiz-navigation">
                <button class="nav-btn prev-btn" onclick="prevQuestion('full')" id="full-back-button">
                    ‚Üê Previous Question
                </button>
                <button class="nav-btn prev-btn disabled" id="full-back-button-off" disabled>
                    ‚Üê Previous Question
                </button>
                <div class="keyboard-hint">
                    Use keys 1-5 or Space to answer
                </div>
            </div>
        </div>
    </main>

    <!-- Unified JavaScript -->
    <script>
        /* ============================
           UTILITY CLASSES
           ============================*/

        class QuizUtils {
            /**
             * Shuffles an array in place using the Fisher-Yates algorithm.
             * @param {Array} array - The array to shuffle
             */
            static shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            /**
             * Gets a query parameter value from the URL
             * @param {string} variable - The name of the query parameter
             * @returns {string|NaN} - The parameter value or NaN if not found
             */
            static getQueryVariable(variable) {
                const query = window.location.search.substring(1);
                const vars = query.split("&");
                for (let i = 0; i < vars.length; i++) {
                    const pair = vars[i].split("=");
                    if (decodeURIComponent(pair[0]) == variable) {
                        return decodeURIComponent(pair[1]);
                    }
                }
                return NaN;
            }

            /**
             * Normalizes a pillar score to a 0-100 range for display
             * @param {number} score - The raw pillar score
             * @returns {number} - Normalized score (0-100)
             */
            static normalizePillarScore(score) {
                const maxPossibleScore = 48;
                const minPossibleScore = -48;
                
                const clampedScore = Math.max(minPossibleScore, Math.min(maxPossibleScore, score));
                
                return ((clampedScore - minPossibleScore) / (maxPossibleScore - minPossibleScore)) * 100;
            }

            /**
             * Updates the progress bar for a given quiz mode
             * @param {number} currentIndex - Current question index
             * @param {number} totalQuestions - Total number of questions
             * @param {string} mode - Quiz mode ('quick' or 'full')
             */
            static updateProgressBar(currentIndex, totalQuestions, mode) {
                const progressPercent = totalQuestions > 0 ? (currentIndex / totalQuestions) * 100 : 0;
                const progressFill = document.getElementById(`${mode}-progress-fill`);
                if (progressFill) {
                    progressFill.style.width = `${progressPercent}%`;
                }
            }

            /**
             * Updates navigation buttons visibility
             * @param {number} currentIndex - Current question index
             * @param {number} totalQuestions - Total number of questions
             * @param {string} mode - Quiz mode ('quick' or 'full')
             */
            static updateNavigationButtons(currentIndex, totalQuestions, mode) {
                const backButton = document.getElementById(`${mode}-back-button`);
                const backButtonOff = document.getElementById(`${mode}-back-button-off`);
                
                if (currentIndex === 0) {
                    if (backButton) backButton.style.display = 'none';
                    if (backButtonOff) backButtonOff.style.display = 'inline-flex';
                } else {
                    if (backButton) backButton.style.display = 'inline-flex';
                    if (backButtonOff) backButtonOff.style.display = 'none';
                }
            }

            /**
             * Builds the results URL with pillar scores
             * @param {Array} pillarScores - Array of 6 pillar scores
             * @returns {string} - Results URL with parameters
             */
            static buildResultsUrl(pillarScores) {
                const params = [
                    `liberty=${this.normalizePillarScore(pillarScores[0])}`,
                    `advancement=${this.normalizePillarScore(pillarScores[1])}`,
                    `ecology=${this.normalizePillarScore(pillarScores[2])}`,
                    `safety=${this.normalizePillarScore(pillarScores[3])}`,
                    `ethics=${this.normalizePillarScore(pillarScores[4])}`,
                    `equity=${this.normalizePillarScore(pillarScores[5])}`
                ];
                
                return `results.html?${params.join('&')}`;
            }
        }

        class DOMUtils {
            /**
             * Safely gets an element by ID
             * @param {string} id - Element ID
             * @returns {Element|null} - The element or null if not found
             */
            static getElementById(id) {
                return document.getElementById(id);
            }

            /**
             * Safely sets text content for an element
             * @param {string} id - Element ID
             * @param {string} text - Text content to set
             */
            static setText(id, text) {
                const element = this.getElementById(id);
                if (element) {
                    element.textContent = text;
                }
            }

            /**
             * Safely sets HTML content for an element
             * @param {string} id - Element ID
             * @param {string} html - HTML content to set
             */
            static setHTML(id, html) {
                const element = this.getElementById(id);
                if (element) {
                    element.innerHTML = html;
                }
            }
        }

        /* ============================
           UNIFIED QUIZ MANAGER
           ============================*/

        class UnifiedQuizManager {
            constructor() {
                this.modes = {
                    quick: {
                        pillarScores: [0, 0, 0, 0, 0, 0],
                        currentQuestionIndex: 0,
                        userResponses: [],
                        questionsInOrder: [],
                        maxQuestions: 18 // Limit for quick quiz
                    },
                    full: {
                        pillarScores: [0, 0, 0, 0, 0, 0],
                        currentQuestionIndex: 0,
                        userResponses: [],
                        questionsInOrder: [],
                        maxQuestions: null // No limit for full quiz
                    }
                };
                
                this.currentMode = 'quick';
                this.scoreLevelValues = [4, 3, 2, 1, -1, -2, -3, -4];
                
                this.initialize();
            }

            /**
             * Initialize the unified quiz
             */
            initialize() {
                this.prepareAllQuestions('quick');
                this.prepareAllQuestions('full');
                this.renderCurrentQuestion('quick');
                this.renderCurrentQuestion('full');
                this.setupKeyboardShortcuts();
                this.updateProgress('quick');
                this.updateProgress('full');
            }

            /**
             * Prepare questions for a specific mode
             * @param {string} mode - Quiz mode ('quick' or 'full')
             */
            prepareAllQuestions(mode) {
                if (typeof questions === 'undefined') {
                    console.error('Questions array not found. Make sure questions.js is loaded.');
                    return;
                }

                const modeData = this.modes[mode];
                modeData.questionsInOrder = [];

                for (let pillarIdx = 0; pillarIdx < questions.length; pillarIdx++) {
                    for (let scoreLevelIdx = 0; scoreLevelIdx < questions[pillarIdx].length; scoreLevelIdx++) {
                        for (let questionInLevelIdx = 0; questionInLevelIdx < questions[pillarIdx][scoreLevelIdx].length; questionInLevelIdx++) {
                            modeData.questionsInOrder.push([pillarIdx, scoreLevelIdx, questionInLevelIdx]);
                        }
                    }
                }

                QuizUtils.shuffleArray(modeData.questionsInOrder);

                // Limit questions for quick quiz
                if (mode === 'quick' && modeData.maxQuestions) {
                    modeData.questionsInOrder = modeData.questionsInOrder.slice(0, modeData.maxQuestions);
                }
            }

            /**
             * Update progress for a specific mode
             * @param {string} mode - Quiz mode
             */
            updateProgress(mode) {
                const modeData = this.modes[mode];
                const progressPercent = modeData.questionsInOrder.length > 0 ? 
                    (modeData.currentQuestionIndex / modeData.questionsInOrder.length) * 100 : 0;
                
                QuizUtils.updateProgressBar(modeData.currentQuestionIndex, modeData.questionsInOrder.length, mode);
                
                const questionNumber = DOMUtils.getElementById(`${mode}-question-number`);
                if (questionNumber) {
                    if (modeData.questionsInOrder.length > 0) {
                        questionNumber.innerHTML = `Question ${modeData.currentQuestionIndex + 1} of ${modeData.questionsInOrder.length}`;
                    } else {
                        questionNumber.innerHTML = "Loading...";
                    }
                }
            }

            /**
             * Render current question for a specific mode
             * @param {string} mode - Quiz mode
             */
            renderCurrentQuestion(mode) {
                const modeData = this.modes[mode];
                
                if (modeData.currentQuestionIndex >= modeData.questionsInOrder.length) {
                    this.showResults(mode);
                    return;
                }

                const [pillarIdx, scoreLevelIdx, questionInLevelIdx] = modeData.questionsInOrder[modeData.currentQuestionIndex];
                
                const questionText = DOMUtils.getElementById(`${mode}-question-text`);
                if (questionText) {
                    questionText.innerHTML = questions[pillarIdx][scoreLevelIdx][questionInLevelIdx];
                    questionText.style.opacity = '0';
                    setTimeout(() => {
                        questionText.style.opacity = '1';
                    }, 50);
                }

                this.updateProgress(mode);
                QuizUtils.updateNavigationButtons(modeData.currentQuestionIndex, modeData.questionsInOrder.length, mode);
            }

            /**
             * Answer a question for a specific mode
             * @param {number} userChoice - User's choice (-2 to 2)
             * @param {string} mode - Quiz mode
             */
            answerQuestion(userChoice, mode) {
                const modeData = this.modes[mode];
                
                // Add visual feedback
                const quizContainer = document.getElementById(`${mode}-quiz`);
                const answerBtns = quizContainer.querySelectorAll('.answer-btn');
                answerBtns.forEach(btn => {
                    if (parseInt(btn.dataset.value) === userChoice) {
                        btn.classList.add('selected');
                        setTimeout(() => btn.classList.remove('selected'), 200);
                    }
                });

                const [pillarIdx, scoreLevelIdx] = modeData.questionsInOrder[modeData.currentQuestionIndex];
                
                const propositionScoreValue = this.scoreLevelValues[scoreLevelIdx];
                const scoreContribution = (userChoice / 2.0) * propositionScoreValue;
                modeData.pillarScores[pillarIdx] += scoreContribution;
                
                modeData.userResponses[modeData.currentQuestionIndex] = userChoice;
                modeData.currentQuestionIndex++;

                setTimeout(() => {
                    if (modeData.currentQuestionIndex < modeData.questionsInOrder.length) {
                        this.renderCurrentQuestion(mode);
                    } else {
                        this.showResults(mode);
                    }
                }, 150);
            }

            /**
             * Go to previous question for a specific mode
             * @param {string} mode - Quiz mode
             */
            prevQuestion(mode) {
                const modeData = this.modes[mode];
                
                if (modeData.currentQuestionIndex === 0) {
                    return;
                }
                
                modeData.currentQuestionIndex--;

                const [pillarIdx, scoreLevelIdx] = modeData.questionsInOrder[modeData.currentQuestionIndex];
                const previousUserChoice = modeData.userResponses[modeData.currentQuestionIndex];
                const propositionScoreValue = this.scoreLevelValues[scoreLevelIdx];

                const scoreToRevert = (previousUserChoice / 2.0) * propositionScoreValue;
                modeData.pillarScores[pillarIdx] -= scoreToRevert;

                this.renderCurrentQuestion(mode);
            }

            /**
             * Show results for a specific mode
             * @param {string} mode - Quiz mode
             */
            showResults(mode) {
                const modeData = this.modes[mode];
                const questionCard = document.querySelector(`#${mode}-quiz .question-card`);
                
                if (questionCard) {
                    questionCard.style.opacity = '0.5';
                    questionCard.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <div class="loading-spinner"></div>
                            <h3>Processing your results...</h3>
                            <p>Analyzing your responses and calculating alignment scores.</p>
                        </div>
                    `;
                }

                setTimeout(() => {
                    const resultsUrl = QuizUtils.buildResultsUrl(modeData.pillarScores);
                    window.location.href = resultsUrl;
                }, 1500);
            }

            /**
             * Setup keyboard shortcuts
             */
            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (event) => {
                    const mode = this.currentMode;
                    const key = event.key;
                    
                    // Number keys 1-5 for answers
                    if (['1', '2', '3', '4', '5'].includes(key)) {
                        event.preventDefault();
                        const choice = parseInt(key) - 3; // Maps 1->-2, 2->-1, 3->0, 4->1, 5->2
                        this.answerQuestion(choice, mode);
                    }
                    
                    // Space for neutral
                    if (key === ' ') {
                        event.preventDefault();
                        this.answerQuestion(0, mode);
                    }
                    
                    // Backspace for previous
                    if (key === 'Backspace') {
                        event.preventDefault();
                        this.prevQuestion(mode);
                    }
                });
            }

            /**
             * Switch between quiz modes
             * @param {string} mode - Quiz mode to switch to
             */
            switchMode(mode) {
                this.currentMode = mode;
                
                // Update toggle buttons
                document.querySelectorAll('.toggle-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Show/hide quiz containers
                document.querySelectorAll('.quiz-mode').forEach(container => {
                    container.classList.remove('active');
                });
                document.getElementById(`${mode}-quiz`).classList.add('active');
            }
        }

        /* ============================
           GLOBAL FUNCTIONS & INITIALIZATION
           ============================*/

        let quizManager;

        // Global functions for onclick handlers
        function answerQuestion(userChoice, mode) {
            if (quizManager) {
                quizManager.answerQuestion(userChoice, mode || quizManager.currentMode);
            }
        }

        function prevQuestion(mode) {
            if (quizManager) {
                quizManager.prevQuestion(mode || quizManager.currentMode);
            }
        }

        function switchQuizMode(mode) {
            if (quizManager) {
                quizManager.switchMode(mode);
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            quizManager = new UnifiedQuizManager();
        });

        // Make utilities globally available
        window.QuizUtils = QuizUtils;
        window.DOMUtils = DOMUtils;
    </script>
</body>
</html>
