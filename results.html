<head>
<link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Roboto:400,700" rel="stylesheet">
<link href='style.css' rel='stylesheet' type='text/css'>
<title>Fusion Party Value Alignment Results</title> <!-- CHANGED -->
<link rel="icon" type="x-icon" href="icon.png">
<link rel="shortcut icon" type="x-icon" href="icon.png">
<meta charset="utf-8">
</head>
<!-- Ensure your archetypes are in fusion_ideologies.js -->
<script type="application/javascript" src="ideologies.js"></script> 

<body>
<h1>Fusion Party Value Alignment</h1> <!-- CHANGED -->
<hr>

<h1>Your Results</h1>

<!-- Section for Personal Liberty -->
<h2><span class="weight-300" id="value-liberty-label">Personal Liberty</span></h2>
<div class="axis">
    <img id="img-liberty-positive" src="value_images/liberty_positive.png" height="128pt"/> <!-- Placeholder image -->
    <div class="bar liberty-positive" id="bar-liberty-positive"><div class="text-wrapper" id="liberty-positive"></div></div>
    <div class="bar liberty-negative" id="bar-liberty-negative"><div class="text-wrapper" id="liberty-negative"></div></div>
    <img id="img-liberty-negative" src="value_images/liberty_negative.png" height="128pt"/> <!-- Placeholder image -->
</div>

<!-- Section for Advancement -->
<h2><span class="weight-300" id="value-advancement-label">Advancement</span></h2>
<div class="axis">
    <img id="img-advancement-positive" src="value_images/advancement_positive.png" height="128pt"/>
    <div class="bar advancement-positive" id="bar-advancement-positive"><div class="text-wrapper" id="advancement-positive"></div></div>
    <div class="bar advancement-negative" id="bar-advancement-negative"><div class="text-wrapper" id="advancement-negative"></div></div>
    <img id="img-advancement-negative" src="value_images/advancement_negative.png" height="128pt"/>
</div>

<!-- Section for Ecological Harmony -->
<h2><span class="weight-300" id="value-harmony-label">Ecological Harmony</span></h2>
<div class="axis">
    <img id="img-harmony-positive" src="value_images/harmony_positive.png" height="128pt"/>
    <div class="bar harmony-positive" id="bar-harmony-positive"><div class="text-wrapper" id="harmony-positive"></div></div>
    <div class="bar harmony-negative" id="bar-harmony-negative"><div class="text-wrapper" id="harmony-negative"></div></div>
    <img id="img-harmony-negative" src="value_images/harmony_negative.png" height="128pt"/>
</div>

<!-- Section for Safety -->
<h2><span class="weight-300" id="value-safety-label">Safety</span></h2>
<div class="axis">
    <img id="img-safety-positive" src="value_images/safety_positive.png" height="128pt"/>
    <div class="bar safety-positive" id="bar-safety-positive"><div class="text-wrapper" id="safety-positive"></div></div>
    <div class="bar safety-negative" id="bar-safety-negative"><div class="text-wrapper" id="safety-negative"></div></div>
    <img id="img-safety-negative" src="value_images/safety_negative.png" height="128pt"/>
</div>

<!-- Section for Ethical Conduct -->
<h2><span class="weight-300" id="value-ethics-label">Ethical Conduct</span></h2>
<div class="axis">
    <img id="img-ethics-positive" src="value_images/ethics_positive.png" height="128pt"/>
    <div class="bar ethics-positive" id="bar-ethics-positive"><div class="text-wrapper" id="ethics-positive"></div></div>
    <div class="bar ethics-negative" id="bar-ethics-negative"><div class="text-wrapper" id="ethics-negative"></div></div>
    <img id="img-ethics-negative" src="value_images/ethics_negative.png" height="128pt"/>
</div>

<!-- Section for Equity -->
<h2><span class="weight-300" id="value-equity-label">Equity</span></h2>
<div class="axis">
    <img id="img-equity-positive" src="value_images/equity_positive.png" height="128pt"/>
    <div class="bar equity-positive" id="bar-equity-positive"><div class="text-wrapper" id="equity-positive"></div></div>
    <div class="bar equity-negative" id="bar-equity-negative"><div class="text-wrapper" id="equity-negative"></div></div>
    <img id="img-equity-negative" src="value_images/equity_negative.png" height="128pt"/>
</div>

<br><br>

<h2 class="ideology">Fusion Party Alignment: <span class="weight-300" id="fusion-match-percentage"></span>%</h1>
<p class="ideology" id="fusion-match-description"></p>

<h2 class="ideology">Closest Archetype Match: <span class="weight-300" id="archetype-label"></span> (<span class="weight-300" id="archetype-match-percentage"></span>% Similar)</h2>
<p class="ideology" id="archetype-match-description"></p>
<!-- You might add a link here to a page explaining the archetypes or Fusion's values in more detail -->

<br><br>

<canvas id="banner" width=800 height=800 style="font-family:Montserrat"></canvas> <!-- Adjusted height for 6 axes -->
<button class="button" onclick="location.href='index.html';" style="background-color: #2196f3;">Back to Quiz</button> <br>
<!-- ADD A BUTTON/LINK HERE TO PASS SCORES TO THE AI AGENT FOR HTV -->
<button class="button" onclick="generateHTV()" style="background-color: #4caf50;">Get My How-To-Vote Suggestion</button> <br>


<script>
    // Ensure valueBasedArchetypes is loaded from fusion_ideologies.js
    // (This script assumes it's globally available)

    function getQueryVariable(variable) {
           const query = window.location.search.substring(1);
           const vars = query.split("&");
           for (let i=0;i<vars.length;i++) {
                   const pair = vars[i].split("=");
                   if(decodeURIComponent(pair[0]) == variable) {return decodeURIComponent(pair[1])}
           }
           return(NaN); // Return NaN if not found
    }

    function setBarValue(valueName, score) { // score is 0-100
        const positiveBar = document.getElementById(`bar-${valueName}-positive`);
        const negativeBar = document.getElementById(`bar-${valueName}-negative`);
        const positiveText = document.getElementById(`${valueName}-positive`);
        const negativeText = document.getElementById(`${valueName}-negative`);

        const positiveScore = score;
        const negativeScore = 100 - score;

        if (positiveBar) positiveBar.style.width = positiveScore + "%";
        if (positiveText) {
            positiveText.innerHTML = positiveScore + "%";
            // Hide text if bar is too small
            if (positiveText.offsetWidth + 20 > positiveBar.offsetWidth) {
                positiveText.style.visibility = "hidden";
            } else {
                positiveText.style.visibility = "visible";
            }
        }
        
        if (negativeBar) negativeBar.style.width = negativeScore + "%";
        if (negativeText) {
            negativeText.innerHTML = negativeScore + "%";
             if (negativeText.offsetWidth + 20 > negativeBar.offsetWidth) {
                negativeText.style.visibility = "hidden";
            } else {
                negativeText.style.visibility = "visible";
            }
        }
    }

    // Define Fusion's 6 Pillars/Values and their corresponding URL parameter names
    const fusionValues = [
        { name: "Personal Liberty", id: "liberty", param: "liberty", positiveImg: "liberty_positive.png", negativeImg: "liberty_negative.png", positiveColor: "#ffeb3b", negativeColor: "#03a9f4"},
        { name: "Advancement", id: "advancement", param: "advance", positiveImg: "advancement_positive.png", negativeImg: "advancement_negative.png", positiveColor: "#4caf50", negativeColor: "#f44336"},
        { name: "Ecological Harmony", id: "harmony", param: "harmony", positiveImg: "harmony_positive.png", negativeImg: "harmony_negative.png", positiveColor: "#8bc34a", negativeColor: "#9c27b0"},
        { name: "Safety", id: "safety", param: "safety", positiveImg: "safety_positive.png", negativeImg: "safety_negative.png", positiveColor: "#1b5e20", negativeColor: "#b71c1c"},
        { name: "Ethical Conduct", id: "ethics", param: "ethics", positiveImg: "ethics_positive.png", negativeImg: "ethics_negative.png", positiveColor: "#00897b", negativeColor: "#ff9800"},
        { name: "Equity", id: "equity", param: "equity", positiveImg: "equity_positive.png", negativeImg: "equity_negative.png", positiveColor: "#3f51b5", negativeColor: "#ea90ab"}
    ];

    let userScores = {};
    fusionValues.forEach(value => {
        const score = parseFloat(getQueryVariable(value.param));
        userScores[value.id] = isNaN(score) ? 50 : score; // Default to 50 if param not found
        setBarValue(value.id, userScores[value.id]);
        // No need for descriptive labels like "Fanatic X" for Fusion values, the % is enough
        document.getElementById(`value-${value.id}-label`).innerHTML = `${value.name}: ${userScores[value.id].toFixed(0)}%`;
    });
    
    /**
     * Calculates similarity between user's scores and an archetype's stats.
     * Returns an object { difference, similarity (0-100%) }
     */
    function calculateSimilarity(userScores, archetypeStats) {
        let totalDifference = 0;
        let valueCount = 0;
        for (const valueKey in archetypeStats) { // Iterate over archetype's defined stats
            if (userScores.hasOwnProperty(valueKey)) {
                totalDifference += Math.abs(userScores[valueKey] - archetypeStats[valueKey]);
                valueCount++;
            }
        }
        if (valueCount === 0) return { difference: Infinity, similarity: 0 }; // Avoid division by zero

        // Max possible difference = number of values * 100 points
        const maxPossibleDifference = valueCount * 100;
        let similarityPercentage = (1 - (totalDifference / maxPossibleDifference)) * 100;
        return { 
            difference: totalDifference, 
            similarity: Math.max(0, Math.round(similarityPercentage)) // Ensure similarity isn't negative, round it
        };
    }

    let closestArchetype = { name: "Unknown", similarity: -1, description: "" };
    let fusionMatchStats = {};

    // valueBasedArchetypes should be loaded from fusion_ideologies.js
    ideologies.forEach(archetype => {
        const matchStats = calculateSimilarity(userScores, archetype.stats);
        if (archetype.name === "Fusion Party Alignment") {
            fusionMatchStats = { ...matchStats, name: archetype.name, description: archetype.description };
        }
        // Find the closest OTHER archetype if you want to display that
        if (matchStats.similarity > closestArchetype.similarity && archetype.name !== "Fusion Party Alignment") {
            closestArchetype = { name: archetype.name, similarity: matchStats.similarity, description: archetype.description };
        }
    });
    
    // If Fusion Party Alignment is itself the closest overall, reflect that.
    if (fusionMatchStats.similarity >= closestArchetype.similarity) {
        closestArchetype = { name: fusionMatchStats.name, similarity: fusionMatchStats.similarity, description: fusionMatchStats.description };
    }


    document.getElementById("fusion-match-percentage").innerHTML = fusionMatchStats.similarity !== undefined ? fusionMatchStats.similarity.toFixed(0) : "N/A";
    document.getElementById("fusion-match-description").innerHTML = fusionMatchStats.description || "See how your values align with the Fusion Party's approach.";
    
    document.getElementById("archetype-label").innerHTML = closestArchetype.name;
    document.getElementById("archetype-match-percentage").innerHTML = closestArchetype.similarity !== undefined ? closestArchetype.similarity.toFixed(0) : "N/A";
    document.getElementById("archetype-match-description").innerHTML = closestArchetype.description || "This archetype represents a general philosophical leaning.";


    // --- Canvas Drawing ---
    window.onload = function() {
        const c = document.getElementById("banner");
        const ctx = c.getContext("2d");
        ctx.fillStyle = "#EEEEEE"; // Background
        ctx.fillRect(0,0,800,800); // Adjusted height

        const barHeight = 80;
        const barGap = 40; // Gap between axes
        const initialY = 70;
        const imgSize = 100;
        const barAreaXStart = 120;
        const barAreaWidth = 560; // Total width for both positive and negative bars

        ctx.fillStyle="#222222";
        ctx.font="700 60px Montserrat"; // Adjusted font size
        ctx.textAlign="center";
        ctx.fillText("Fusion Value Alignment", 400, 50); // Centered title

        fusionValues.forEach((value, index) => {
            const yPos = initialY + index * (barHeight + barGap);
            const barYPos = yPos + (imgSize - barHeight) / 2 + 5; // Center bar with image
            const textYPos = barYPos + barHeight / 2 + 15; // Approx center for text

            // Draw Images (Placeholders - ensure you have these images)
            let imgPositive = new Image();
            imgPositive.src = `value_images/${value.positiveImg}`;
            imgPositive.onload = () => ctx.drawImage(imgPositive, 20, yPos, imgSize, imgSize);
            
            let imgNegative = new Image();
            imgNegative.src = `value_images/${value.negativeImg}`;
            imgNegative.onload = () => ctx.drawImage(imgNegative, 680, yPos, imgSize, imgSize);

            // Background for bars
            ctx.fillStyle="#DDDDDD"; // Lighter background for the bar area
            ctx.fillRect(barAreaXStart, barYPos, barAreaWidth, barHeight);

            // Positive score bar
            const positiveWidth = (userScores[value.id] / 100) * barAreaWidth;
            ctx.fillStyle = value.positiveColor;
            ctx.fillRect(barAreaXStart, barYPos, positiveWidth, barHeight);

            // Negative score bar (fills the rest)
            const negativeWidth = barAreaWidth - positiveWidth;
            ctx.fillStyle = value.negativeColor;
            ctx.fillRect(barAreaXStart + positiveWidth, barYPos, negativeWidth, barHeight);
            
            // Text on bars
            ctx.fillStyle = "#FFFFFF"; // White text for better contrast on colored bars
            ctx.font = "bold 30px Montserrat";
            ctx.textAlign = "left";
            if (userScores[value.id] > 15) { // Only draw if bar is wide enough
                 ctx.fillText(`${userScores[value.id].toFixed(0)}%`, barAreaXStart + 5, textYPos);
            }
            ctx.textAlign = "right";
            if ((100 - userScores[value.id]) > 15) {
                 ctx.fillText(`${(100 - userScores[value.id]).toFixed(0)}%`, barAreaXStart + barAreaWidth - 5, textYPos);
            }

            // Value Name Label
            ctx.fillStyle = "#222222";
            ctx.font = "bold 24px Montserrat";
            ctx.textAlign="center";
            ctx.fillText(value.name, 400, yPos - 5); // Label above the bar
        });

        // Footer text
        ctx.font="300 20px Montserrat";
        ctx.fillStyle = "#555555";
        ctx.textAlign="center";
        ctx.fillText("FusionParty.org.au/values-quiz", 400, 780); // Example footer
    };

    function generateHTV() {
        // This function will pass the userScores to your AI agent
        // For now, let's just alert them or log them
        let scoresString = "Your Fusion Value Scores:\n";
        for (const valueId in userScores) {
            scoresString += `${fusionValues.find(v => v.id === valueId).name}: ${userScores[valueId].toFixed(0)}%\n`;
        }
        scoresString += "\n(These scores will be sent to the AI for your How-To-Vote suggestion)";
        alert(scoresString);
        console.log(userScores);

        // TODO: Implement the actual call to your AI agent here, passing userScores
        // e.g., callFusionAIAgentForHTV(userScores, userElectorate);
        // You'll need to get userElectorate from an input field on this page or a previous one.
    }

</script>
</body>